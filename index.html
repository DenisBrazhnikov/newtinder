<html>  
    <head>

    </head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fuzzy+Bubbles&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        body {
            overscroll-behavior: contain;
        }

        .parent {
            position: relative;
            perspective: 2000px;
            width: 262px;
            height: 242px;
            margin: 0 auto;
            margin-top: 100px;
        }

        #buttons {
            position: absolute;
            bottom: -70px;
            width: 100%;
            height: 50px;
            text-align: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 2s ease-in-out;
        }

        #buttons button {
            border-radius: 50%;
            border: none;
            height: 40px;
            width: 40px;
            margin-top: 10px;
            font-size: 20px;
            background: #0000000a;
            box-shadow: 0px 0px 20px 1px #00000045;
        }

        .card {  
            font-family: 'Fuzzy Bubbles', cursive;
            font-size: 15px;
            width: 110px;
            height: 100px;
            padding: 10px;
            position: absolute;
            border: 1px solid #ececec;
            background-color: burlywood;
            color: transparent;
            display: none;
            transform-origin: 0 0;
            transition: transform, opacity .1s ease-in-out;
        }

        #first {
            transform: rotateY(0deg);
            text-align: right;
            z-index: 1;
            display: block;
        }

        #second {
            transform: rotateY(180deg);
            text-align: left;
            z-index: 2;
            left: 130px;
        }

        #third {
            transform: rotateX(180deg);
            text-align: center;
            z-index: 3;
            width: 240px;
            opacity: 0.6;
            top: 120px;
        }
    </style>
    <body>
        <div class="parent">
            <div class="card" id="first">
                Когда
                <br> 
                тебя, то 
                <br>
                вспомнил
                <br>
                задание
            </div>
            <div class="card" id="second">
                увидел
                <br>
                сразу
                <br>
                школьное
                <br>
                с доски
            </div>
            <div class="card" id="third">тоже хочеться сфоткать и все сделать дома уже</div>
            <div id="buttons">
                <button onclick="jsConfetti.addConfetti();" style="margin-right: 30px; color: #40b71a;"><i class="fa fa-heart"></i></button>
                <button style="color: red;"><i class="fa fa-times"></i></button>
            </div>
          </div> 
    </body>

    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <script>
        const jsConfetti = new JSConfetti()

        document.addEventListener('touchstart', handleTouchStart, false);
        document.addEventListener('touchmove', handleTouchMove, false);
        document.addEventListener('touchend', handleTouchEnd, false);
        var TOUCH_MOVES = false;
        const STATE_FIRST = 0;
        const STATE_SECOND = 1;
        const STATE_THIRD = 2;

        const FUCKING_EASING = 'all 1.3s cubic-bezier(0.22, 1, 0.36, 1)';

        const DEGRESS_MAX = 0;
        const DEGRESS_MIN = -180;
        const DEGRESS_THRESHOLD = 95;

        var cardState = STATE_FIRST;
        let degress = 0;

        var rightCard = document.getElementById("first");

        var startX;
        var startY;

        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value))
        }

        function handleTouchStart(event) {
            const firstTouch = event.touches[0];
             startX = firstTouch.clientX; 
             startY = firstTouch.clientY;
             console.log('handleTouchStart', startX, startY); 
        }

        function handleTouchEnd(event) {
            if (cardState < STATE_THIRD && degress < DEGRESS_THRESHOLD && TOUCH_MOVES) {
                cardState = cardState + 1;
                setState(cardState++);
            } else {
                refreshState(cardState);
            }

            TOUCH_MOVES = false;
        }

        function handleTouchMove(event) {
            TOUCH_MOVES = true;
            const cardWidth = rightCard.offsetWidth;
            let axis;
            let diff;
            let elementId;

            switch (cardState) {
                case STATE_FIRST:
                    diff = startX - event.touches[0].clientX;
                    initState();
                    axis = 'y';
                    elementId = 'second';
                    break;
                case STATE_SECOND:
                    diff = startY - event.touches[0].clientY;
                    axis = 'x';
                    elementId = 'third';
                    break;
                default:
                    return;
            }

            degress = clamp(180 - Math.floor(-diff * 180 / (cardWidth * 2)), 0, 180);

            console.log(diff, degress);
            // super smoooooth
            setDegress(elementId, degress, axis);
        }

        function setDegress(elementId, degress, axis, displayText = false, selfEnding = false) {
            let element = document.getElementById(elementId);
            let axisX = axis == 'x' ? 1 : 0;
            let axisY = axis == 'y' ? 1 : 0;
            let axisZ = axis == 'z' ? 1 : 0;
            if (!element) {
                throw new `Element not found: #${elementId}`;
            }

            if(displayText || degress < DEGRESS_THRESHOLD) {
                element.style.color = 'white';
                element.style.opacity = 1;
            } else {
                element.style.color = 'transparent';

                if(cardState) {
                    element.style.opacity = '0.6';
                }
            }

            if(selfEnding) {
                element.style.transition = FUCKING_EASING;
            } else {
                element.style.transition = 'none';
            }

            if(cardState > 1) {
                element.style.opacity = 1 - degress / 180;
            }
            console.log( 1.5 -  degress / 180);
            
            element.style.transform = `rotate3d(${axisX}, ${axisY}, ${axisZ} , ${degress}deg)`;
            element.style.display = 'block';
        }

        function initState() {
            let first = document.getElementById('first');
            first.style.color = 'white';
        }

        function refreshState(cardState) {
            switch (cardState) {
                case STATE_FIRST:
                    let second = document.getElementById('second');
                    second.style.transition = FUCKING_EASING;
                    second.style.color = 'transparent';
                    second.style.transform = 'rotateY(180deg)';
                    break;
                case STATE_SECOND:
                    let third = document.getElementById('third');
                    third.style.transition = FUCKING_EASING;
                    third.style.transform = 'rotateX(180deg)';
                    third.style.color = 'transparent';
                    third.style.opacity = '0';
                    break;
                case STATE_THIRD:
                    setDegress('third', 0, 'x', true);
                    break;
            }
        }

        function setState(newState) {
            switch (newState) {
                case STATE_FIRST:
                    
                    break;
                case STATE_SECOND:
                    setDegress('second', 0, 'y', true, true);
                    break;
                case STATE_THIRD:
                    setDegress('third', 0, 'x', true, true);
                    let buttons = document.getElementById('buttons');
                    buttons.style.opacity = '1';
                    buttons.style.visibility = 'visible';
                    break;
            }
            cardState = newState;
        }

    </script>
</html>